# CLAUDE.md

ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã€Claude Code (claude.ai/code) ãŒã“ã®ãƒªãƒã‚¸ãƒˆãƒªã§ä½œæ¥­ã™ã‚‹éš›ã®ã‚¬ã‚¤ãƒ€ãƒ³ã‚¹ã‚’æä¾›ã—ã¾ã™ã€‚

## ğŸ“‹ å®Ÿè£…ãƒã‚±ãƒƒãƒˆã®é€²æ—ç®¡ç†

ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã¯`/docs`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…ã®ãƒã‚±ãƒƒãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã§å®Ÿè£…ã‚¿ã‚¹ã‚¯ã‚’ç®¡ç†ã—ã¦ã„ã¾ã™ã€‚

### ãƒã‚±ãƒƒãƒˆç®¡ç†ã®ãƒ«ãƒ¼ãƒ«
1. **å„ãƒã‚±ãƒƒãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®æ§‹æˆ**:
   - ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: `[ ]` æœªç€æ‰‹ / `[x]` å®Œäº†
   - ã‚¿ã‚¹ã‚¯: å®Ÿè£…ã™ã¹ãè©³ç´°ã‚¿ã‚¹ã‚¯ã®ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ
   - å®Œäº†æ¡ä»¶: ãƒã‚±ãƒƒãƒˆã‚’å®Œäº†ã¨ã¿ãªã™æ¡ä»¶

2. **ã‚¿ã‚¹ã‚¯å®Ÿè£…æ™‚ã®æ‰‹é †**:
   - ãƒã‚±ãƒƒãƒˆå†…ã®ã‚¿ã‚¹ã‚¯ã‚’1ã¤ãšã¤å®Ÿè£…
   - ã‚¿ã‚¹ã‚¯å®Œäº†æ™‚ã€å¿…ãš `- [ ]` ã‚’ `- [x]` ã«æ›´æ–°
   - **ã™ã¹ã¦ã®ã‚¿ã‚¹ã‚¯ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’å¿…ãšç¢ºèªãƒ»æ›´æ–°ã™ã‚‹ã“ã¨**
   - ãƒã‚±ãƒƒãƒˆå†…ã®ã™ã¹ã¦ã®ã‚¿ã‚¹ã‚¯ãŒå®Œäº†ã—ãŸã‚‰ã€ä¸Šéƒ¨ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚‚ `[x]` ã«å¤‰æ›´

3. **é€²æ—ç¢ºèª**:
   - `docs/README.md` ã§å…¨ä½“ã®é€²æ—ã‚’ç¢ºèª
   - å„ãƒã‚±ãƒƒãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã§è©³ç´°ãªé€²æ—ã‚’ç¢ºèª

4. **é‡è¦**:
   - ã‚¿ã‚¹ã‚¯å®Œäº†æ™‚ã€è©²å½“ã™ã‚‹ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’ **å¿…ãšæ›´æ–°** ã™ã‚‹ã“ã¨
   - ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®æ›´æ–°ã‚’å¿˜ã‚Œã‚‹ã¨é€²æ—ãŒæ­£ã—ãè¿½è·¡ã§ããªã„

## ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¦‚è¦

**Zettelkastenæƒ…å ±ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ** - Notionã¨Obsidianã‚’èåˆã•ã›ãŸã‚ˆã†ãªçŸ¥è­˜ç®¡ç†ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã€‚å€‹äººåˆ©ç”¨ã‹ã‚‰ãƒãƒ¼ãƒ åˆ©ç”¨ã¾ã§å¯¾å¿œå¯èƒ½ãªã€Markdownå¯¾å¿œã®æƒ…å ±ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ã§ã™ã€‚

æ€è€ƒã®æ–­ç‰‡ï¼ˆèµ°ã‚Šæ›¸ãï¼‰ã‹ã‚‰ä½“ç³»çš„ãªçŸ¥è­˜ï¼ˆæ°¸ä¹…ä¿å­˜ãƒ¡ãƒ¢ï¼‰ã¸ã®å¤‰æ›ã‚’æ”¯æ´ã—ã€ãƒãƒ¼ãƒˆé–“ã®ãƒªãƒ³ã‚¯ã‚’å¯è¦–åŒ–ã—ã¦çŸ¥è­˜ã®ã¤ãªãŒã‚Šã‚’ç™ºè¦‹ã—ã¾ã™ã€‚

## æ ¸å¿ƒæ¦‚å¿µ

Zettelkastenæ–¹å¼ã«å¾“ã£ãŸ3ç¨®é¡ã®ãƒ¡ãƒ¢ã‚’ç®¡ç†ã—ã¾ã™ï¼š

1. **èµ°ã‚Šæ›¸ããƒ¡ãƒ¢ (Fleeting Notes)**: ä¸€æ™‚çš„ãªã‚¢ã‚¤ãƒ‡ã‚¢ãƒ»æ€ã„ã¤ãã‚’ç´ æ—©ãè¨˜éŒ²ã€‚ã€Œãƒ¡ãƒ¢æ¸ˆã¿ã€ã«ã™ã‚‹ã¨è‡ªå‹•çš„ã«æ°¸ä¹…ä¿å­˜ãƒ¡ãƒ¢ãŒç”Ÿæˆã•ã‚Œã‚‹
2. **æ–‡çŒ®ãƒ¡ãƒ¢ (Literature Notes)**: å¤–éƒ¨ã‚½ãƒ¼ã‚¹ï¼ˆæœ¬ã€è¨˜äº‹ã€Webï¼‰ã‹ã‚‰ã®å¼•ç”¨ãƒ»è¦ç´„ã€‚URLï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰ã‚’å«ã‚€
3. **æ°¸ä¹…ä¿å­˜ãƒ¡ãƒ¢ (Permanent Notes)**: æ•´ç†ã•ã‚ŒãŸçŸ¥è­˜ã¨ã—ã¦ä½“ç³»çš„ã«ä¿å­˜ã€‚åŸå­çš„ï¼ˆ1ã¤ã®æ¦‚å¿µï¼1ãƒ¡ãƒ¢ï¼‰ã«æ§‹æˆã•ã‚Œã€ä»–ã®ãƒ¡ãƒ¢ã¨ãƒªãƒ³ã‚¯å¯èƒ½

èµ°ã‚Šæ›¸ããƒ¡ãƒ¢ã¾ãŸã¯æ–‡çŒ®ãƒ¡ãƒ¢ã‚’ã€Œãƒ¡ãƒ¢æ¸ˆã¿ã€ã«ã™ã‚‹ã¨ã€æ°¸ä¹…ä¿å­˜ãƒ¡ãƒ¢ãŒè‡ªå‹•çš„ã«ä½œæˆã•ã‚Œã€å…ƒãƒ¡ãƒ¢ã¯ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã•ã‚Œã¾ã™ï¼ˆå‰Šé™¤ã¯ã—ãªã„ï¼‰ã€‚

## æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯

- **Next.js 15** (App Router)
- **React 19**
- **TypeScript 5**
- **Tailwind CSS 4** (æ–°PostCSSã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£)
- **Prisma 6** (ORM)
- **Supabase** (PostgreSQL)
- **Auth.js v5** (NextAuth.js v5)
- **Zod 3** (ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³)
- **react-markdown 9** + remark-gfm 4 + rehype-highlight 7
- **D3.js 7** (ã‚°ãƒ©ãƒ•ãƒ“ãƒ¥ãƒ¼)

## é–‹ç™ºã‚³ãƒãƒ³ãƒ‰

```bash
# é–‹ç™ºã‚µãƒ¼ãƒãƒ¼èµ·å‹•
npm run dev

# æœ¬ç•ªãƒ“ãƒ«ãƒ‰
npm run build

# æœ¬ç•ªã‚µãƒ¼ãƒãƒ¼èµ·å‹•
npm run start

# ãƒªãƒ³ã‚¿ãƒ¼å®Ÿè¡Œ
npm run lint

# Prismaãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç”Ÿæˆ
npx prisma migrate dev

# Prisma Studioèµ·å‹•ï¼ˆDBç®¡ç†GUIï¼‰
npx prisma studio

# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’Prismaã‚¹ã‚­ãƒ¼ãƒã¨åŒæœŸ
npx prisma db push
```

## ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆï¼ˆå®Ÿè£…äºˆå®šï¼‰

ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«ã®éšå±¤æ§‹é€ ï¼š

```
User (1:N)
â”œâ”€ FleetingNote (isDoneãƒ•ãƒ©ã‚° â†’ PermanentNoteã‚’è‡ªå‹•ç”Ÿæˆ)
â”œâ”€ LiteratureNote (isDoneãƒ•ãƒ©ã‚° â†’ PermanentNoteã‚’è‡ªå‹•ç”Ÿæˆ)
â””â”€ PermanentNote
   â”œâ”€ N:M Categoryï¼ˆãƒ•ãƒ©ãƒƒãƒˆæ§‹é€ ã€éšå±¤ãªã—ï¼‰
   â”œâ”€ N:M LiteratureNoteï¼ˆå¼•ç”¨é–¢ä¿‚ï¼‰
   â””â”€ N:M è‡ªå·±å‚ç…§ï¼ˆæ°¸ä¹…ä¿å­˜ãƒ¡ãƒ¢åŒå£«ã®åŒæ–¹å‘ãƒªãƒ³ã‚¯ï¼‰
```

å®Ÿè£…ã™ã¹ãä¸»è¦ãƒ†ãƒ¼ãƒ–ãƒ«ï¼š
- **èªè¨¼**: `users`, `accounts`, `sessions`, `verification_tokens`
- **ãƒ¡ãƒ¢**: `fleeting_notes`, `literature_notes`, `permanent_notes`, `permanent_note_links`
- **ã‚«ãƒ†ã‚´ãƒªãƒ¼**: `categories`, `categories_on_permanent_notes`, `categories_on_literature_notes`
- **ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³**: `permanent_notes_on_literature_notes`

### é‡è¦ãªãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰

- **PermanentNote**: `sourceType`ã¨`sourceId`ã§å…ƒãƒ¡ãƒ¢ã‚’è¿½è·¡ï¼ˆfleeting/literature/manualï¼‰
- **PermanentNote**: `showInGraph`ã§ã‚°ãƒ©ãƒ•ãƒ“ãƒ¥ãƒ¼ã¸ã®è¡¨ç¤ºã‚’åˆ¶å¾¡
- **FleetingNote/LiteratureNote**: `isDone`ãƒ•ãƒ©ã‚°ã§æ°¸ä¹…ä¿å­˜ãƒ¡ãƒ¢ã®è‡ªå‹•ä½œæˆã‚’ãƒˆãƒªã‚¬ãƒ¼

### Markdownãƒªãƒ³ã‚¯è¨˜æ³•

`[[ãƒ¡ãƒ¢ã‚¿ã‚¤ãƒˆãƒ«]]`è¨˜æ³•ï¼ˆObsidian/Roamé¢¨ï¼‰ã‚’ä½¿ç”¨ã—ã¦å†…éƒ¨ãƒªãƒ³ã‚¯ã‚’ä½œæˆã€‚ãƒ‘ãƒ¼ã‚µãƒ¼ã§ã“ã‚Œã‚’æ¤œå‡ºã—ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚·ãƒƒãƒ—ã«å¤‰æ›ã—ã¦ãƒãƒƒã‚¯ãƒªãƒ³ã‚¯è¿½è·¡ã‚’å®Ÿç¾ã—ã¾ã™ã€‚

### ã‚°ãƒ©ãƒ•ãƒ“ãƒ¥ãƒ¼å®Ÿè£…

D3.jsã‚’ä½¿ç”¨ã—ã¦æ°¸ä¹…ä¿å­˜ãƒ¡ãƒ¢ã¨ãã®æ¥ç¶šã‚’å¯è¦–åŒ–ã€‚ãƒãƒ¼ãƒ‰ã¯ãƒ¡ãƒ¢ã€ã‚¨ãƒƒã‚¸ã¯åŒæ–¹å‘ãƒªãƒ³ã‚¯ã‚’è¡¨ç¾ã€‚ãƒãƒ¼ãƒ‰ã‚¯ãƒªãƒƒã‚¯ã§ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºã€‚ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚„ãƒ¡ãƒ¢ã‚¿ã‚¤ãƒ—ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°å¯èƒ½ã€‚

## UI/UXã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

### ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆæ§‹é€ 
- **ã‚µã‚¤ãƒ‰ãƒãƒ¼** (LINKã‚»ã‚¯ã‚·ãƒ§ãƒ³): ã‚«ãƒ†ã‚´ãƒªãƒ¼ã€`isDone=true`ã®æ–‡çŒ®ãƒ¡ãƒ¢ã€æ°¸ä¹…ä¿å­˜ãƒ¡ãƒ¢ä¸€è¦§ã‚’è¡¨ç¤º
- **ãƒ¡ã‚¤ãƒ³ã‚¨ãƒªã‚¢**: 3ã‚«ãƒ©ãƒ ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼ˆãƒ¢ãƒã‚¤ãƒ«ã§ã¯ã‚¿ãƒ–åˆ‡æ›¿ï¼‰ã§èµ°ã‚Šæ›¸ã/æ–‡çŒ®/æ°¸ä¹…ä¿å­˜ãƒ¡ãƒ¢ã‚’è¡¨ç¤º
- **ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚·ã‚¹ãƒ†ãƒ **: å…¨ãƒ¡ãƒ¢ã‚¿ã‚¤ãƒ—ã®é–²è¦§ãƒ»ç·¨é›†ç”¨ã®çµ±ä¸€ãƒ¢ãƒ¼ãƒ€ãƒ«ã€‚ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ‰ã¨ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã‚’åˆ‡æ›¿
- **ã‚°ãƒ©ãƒ•ãƒ“ãƒ¥ãƒ¼**: ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ä»˜ãã®ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³D3.jså¯è¦–åŒ–

### ãƒ¢ãƒ¼ãƒ€ãƒ«ã®æŒ™å‹•
- **é–‹ãæ–¹**: ãƒ¡ãƒ¢ã‚«ãƒ¼ãƒ‰ã€ã‚°ãƒ©ãƒ•ã®ãƒãƒ¼ãƒ‰ã€ã‚«ãƒ†ã‚´ãƒªãƒ¼ãƒšãƒ¼ã‚¸ã‹ã‚‰ã‚¯ãƒªãƒƒã‚¯
- **2ã¤ã®ãƒ¢ãƒ¼ãƒ‰**: ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆèª­ã¿å–ã‚Šå°‚ç”¨ï¼‰ã¨ç·¨é›†ï¼ˆãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ Markdownãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼‰
- **å¸¸ã«è¡¨ç¤º**: ã‚¿ã‚¤ãƒˆãƒ«ã€ã‚«ãƒ†ã‚´ãƒªãƒ¼ã€Markdownæœ¬æ–‡ã€ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã€ä¸‹éƒ¨ã®ãƒãƒƒã‚¯ãƒªãƒ³ã‚¯ã‚»ã‚¯ã‚·ãƒ§ãƒ³

## å®Ÿè£…ãƒ•ã‚§ãƒ¼ã‚º

### Phase 1ï¼ˆç¾åœ¨ã®MVPç›®æ¨™ï¼‰
- èªè¨¼ã‚·ã‚¹ãƒ†ãƒ ï¼ˆãƒ¡ãƒ¼ãƒ«/ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ + Google OAuthï¼‰
- 3ç¨®é¡ã®ãƒ¡ãƒ¢ã®CRUDæ“ä½œ
- ã€Œãƒ¡ãƒ¢æ¸ˆã¿ã€ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ â†’ æ°¸ä¹…ä¿å­˜ãƒ¡ãƒ¢ã®è‡ªå‹•ç”Ÿæˆ
- å¤šå¯¾å¤šã®ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚·ã‚¹ãƒ†ãƒ 
- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼/ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ä»˜ããƒ¢ãƒ¼ãƒ€ãƒ«ã‚·ã‚¹ãƒ†ãƒ 
- åŸºæœ¬UIãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼ˆã‚µã‚¤ãƒ‰ãƒãƒ¼ã€ãƒ¡ã‚¤ãƒ³ã‚¨ãƒªã‚¢ï¼‰
- é™çš„ãªæ¤œç´¢UIï¼ˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰æœªå®Ÿè£…ï¼‰

### Phase 2
- `[[ãƒªãƒ³ã‚¯]]`è¨˜æ³•ã®ãƒ‘ãƒ¼ã‚¹ã¨ãƒãƒƒã‚¯ãƒªãƒ³ã‚¯æ¤œå‡º
- åŸºæœ¬çš„ãªã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³æ©Ÿèƒ½ã‚’æŒã¤D3.jsã‚°ãƒ©ãƒ•ãƒ“ãƒ¥ãƒ¼
- å…¨æ–‡æ¤œç´¢ã®å®Ÿè£…ï¼ˆSupabase FTSã¾ãŸã¯Fuse.jsï¼‰

### Phase 3
- ã‚°ãƒ©ãƒ•ãƒ“ãƒ¥ãƒ¼ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ï¼ˆã‚«ãƒ†ã‚´ãƒªãƒ¼åˆ¥ã€ãƒ¡ãƒ¢ã‚¿ã‚¤ãƒ—åˆ¥ï¼‰
- ãƒãƒ¼ãƒ æ©Ÿèƒ½ï¼ˆãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã€æ‹›å¾…ï¼‰
- ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ©Ÿèƒ½ã€ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆã€ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰

## ãƒ‘ã‚¹ã‚¨ã‚¤ãƒªã‚¢ã‚¹

`tsconfig.json`ã§è¨­å®šã•ã‚Œã¦ã„ã‚‹`@/*`ã‚’ä½¿ç”¨ã—ã¦`src`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‹ã‚‰ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã™ï¼š

```typescript
import Component from '@/components/Component'
import { helper } from '@/lib/utils'
```

## ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆ

å®Ÿè£…æ™‚ã¯ä»¥ä¸‹ã®æ§‹é€ ã«å¾“ã£ã¦ãã ã•ã„ï¼š

```
src/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ (auth)/              # èªè¨¼ãƒ«ãƒ¼ãƒˆ
â”‚   â”‚   â”œâ”€â”€ login/
â”‚   â”‚   â””â”€â”€ register/
â”‚   â”œâ”€â”€ (dashboard)/         # ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒª
â”‚   â”‚   â”œâ”€â”€ page.tsx         # ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸
â”‚   â”‚   â”œâ”€â”€ fleeting/        # èµ°ã‚Šæ›¸ããƒ¡ãƒ¢
â”‚   â”‚   â”œâ”€â”€ literature/      # æ–‡çŒ®ãƒ¡ãƒ¢
â”‚   â”‚   â”œâ”€â”€ permanent/       # æ°¸ä¹…ä¿å­˜ãƒ¡ãƒ¢
â”‚   â”‚   â”œâ”€â”€ categories/      # ã‚«ãƒ†ã‚´ãƒªãƒ¼
â”‚   â”‚   â””â”€â”€ graph/           # ã‚°ãƒ©ãƒ•ãƒ“ãƒ¥ãƒ¼
â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â”œâ”€â”€ auth/[...nextauth]/
â”‚   â”‚   â”œâ”€â”€ fleeting/
â”‚   â”‚   â”œâ”€â”€ literature/
â”‚   â”‚   â”œâ”€â”€ permanent/
â”‚   â”‚   â”œâ”€â”€ categories/
â”‚   â”‚   â”œâ”€â”€ graph/
â”‚   â”‚   â””â”€â”€ search/
â”‚   â””â”€â”€ layout.tsx
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ layout/
â”‚   â”‚   â”œâ”€â”€ Sidebar.tsx
â”‚   â”‚   â””â”€â”€ Header.tsx
â”‚   â”œâ”€â”€ notes/
â”‚   â”‚   â”œâ”€â”€ NoteCard.tsx
â”‚   â”‚   â”œâ”€â”€ NoteModal.tsx
â”‚   â”‚   â”œâ”€â”€ NoteEditor.tsx
â”‚   â”‚   â”œâ”€â”€ NotePreview.tsx
â”‚   â”‚   â””â”€â”€ BacklinkSection.tsx
â”‚   â”œâ”€â”€ graph/
â”‚   â”‚   â”œâ”€â”€ GraphView.tsx
â”‚   â”‚   â”œâ”€â”€ GraphFilter.tsx
â”‚   â”‚   â””â”€â”€ GraphNodeModal.tsx
â”‚   â”œâ”€â”€ category/
â”‚   â”‚   â”œâ”€â”€ CategoryList.tsx
â”‚   â”‚   â””â”€â”€ CategoryCard.tsx
â”‚   â”œâ”€â”€ search/
â”‚   â”‚   â””â”€â”€ SearchBar.tsx
â”‚   â””â”€â”€ ui/                  # æ±ç”¨UI
â”œâ”€â”€ lib/
â”‚   â”œâ”€â”€ prisma.ts
â”‚   â”œâ”€â”€ auth.ts
â”‚   â”œâ”€â”€ markdown.ts
â”‚   â”œâ”€â”€ link-parser.ts
â”‚   â””â”€â”€ graph-data.ts
â”œâ”€â”€ hooks/
â”‚   â”œâ”€â”€ useNotes.ts
â”‚   â”œâ”€â”€ useCategories.ts
â”‚   â””â”€â”€ useModal.ts
â”œâ”€â”€ types/
â”‚   â”œâ”€â”€ note.ts
â”‚   â”œâ”€â”€ category.ts
â”‚   â””â”€â”€ graph.ts
â””â”€â”€ utils/
    â””â”€â”€ validators.ts        # Zodã‚¹ã‚­ãƒ¼ãƒ
```

## ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¦ç´„

- UIãƒ†ã‚­ã‚¹ãƒˆã¨ã‚³ãƒ¡ãƒ³ãƒˆã¯æ—¥æœ¬èªã§è¨˜è¿°
- Next.js 15 App Routerè¦ç´„ã«å¾“ã£ãŸå³æ ¼ãªTypeScriptã‚’ä½¿ç”¨
- ESLintã¯Next.js core-web-vitalsã¨TypeScriptãƒ—ãƒªã‚»ãƒƒãƒˆã‚’ä½¿ç”¨
- Tailwind CSS v4ã®æ–°ã—ã„PostCSSã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã‚’ä½¿ç”¨ï¼ˆ`@tailwindcss/postcss`ä¾å­˜ï¼‰
- Prismaã‚¹ã‚­ãƒ¼ãƒã¯`prisma/schema.prisma`ã«å®šç¾©

## Next.js App Router ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

### ã‚µãƒ¼ãƒãƒ¼ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

#### ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯Server Components
- **ã™ã¹ã¦ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§Server Components**ã¨ã—ã¦å®Ÿè£…
- ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚§ãƒƒãƒã‚„ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒªã‚½ãƒ¼ã‚¹ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã¯Server Componentsã§è¡Œã†
- `'use client'`ã¯å¿…è¦ãªå ´åˆã®ã¿ä½¿ç”¨

#### Client ComponentsãŒå¿…è¦ãªã‚±ãƒ¼ã‚¹
ä»¥ä¸‹ã®æ©Ÿèƒ½ã‚’ä½¿ç”¨ã™ã‚‹å ´åˆã®ã¿`'use client'`ã‚’è¿½åŠ ï¼š
- `useState`, `useEffect`, `useReducer`ãªã©ã®React Hooks
- ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼ï¼ˆ`onClick`, `onChange`ãªã©ï¼‰
- ãƒ–ãƒ©ã‚¦ã‚¶APIï¼ˆ`localStorage`, `window`ãªã©ï¼‰
- ã‚«ã‚¹ã‚¿ãƒ ãƒ•ãƒƒã‚¯
- React Context

#### ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆè¨­è¨ˆã®æ¨å¥¨ãƒ‘ã‚¿ãƒ¼ãƒ³
```typescript
// âœ… è‰¯ã„ä¾‹: Server Componentã§ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚§ãƒƒãƒã—ã¦Client Componentã«æ¸¡ã™
// app/notes/page.tsx (Server Component)
export default async function NotesPage() {
  const notes = await fetchNotes(); // ã‚µãƒ¼ãƒãƒ¼ã§å®Ÿè¡Œ
  return <NoteList notes={notes} />; // Client Componentã«propsã§æ¸¡ã™
}

// components/notes/NoteList.tsx (Client Component)
'use client';
export function NoteList({ notes }) {
  const [selected, setSelected] = useState(null);
  // ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ãªå‡¦ç†
}

// âŒ æ‚ªã„ä¾‹: Client Componentã§ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚§ãƒƒãƒã™ã‚‹ã®ã¯NG
'use client';
export function NoteList() {
  const [notes, setNotes] = useState([]);
  useEffect(() => {
    fetch('/api/notes').then(/* ... */); // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§ä¸å¿…è¦ãªãƒ•ã‚§ãƒƒãƒ
  }, []);
}
```

### ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚§ãƒƒãƒãƒ³ã‚°

#### Server Componentsã§ã®ç›´æ¥ãƒ•ã‚§ãƒƒãƒ
```typescript
// âœ… æ¨å¥¨: Server Componentã§Prismaç›´æ¥ä½¿ç”¨
import { prisma } from '@/lib/prisma';

export default async function NotesPage() {
  const notes = await prisma.permanentNote.findMany({
    where: { userId: session.user.id },
    include: { categories: true }
  });

  return <NoteList notes={notes} />;
}
```

#### API Routesã®ä½¿ç”¨åˆ¤æ–­
ä»¥ä¸‹ã®å ´åˆã«API Routesã‚’ä½¿ç”¨ï¼š
- ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã‹ã‚‰ã®ãƒŸãƒ¥ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆPOST/PUT/DELETEï¼‰
- Webhookã‚„ã‚µãƒ¼ãƒ‰ãƒ‘ãƒ¼ãƒ†ã‚£ã‹ã‚‰ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆå—ä¿¡
- è¤‡é›‘ãªãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã®åˆ†é›¢

#### Server Actionsã®æ´»ç”¨
ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡ã‚„ãƒŸãƒ¥ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã«ã¯**Server Actions**ã‚’å„ªå…ˆçš„ã«ä½¿ç”¨ï¼š

```typescript
// app/notes/actions.ts
'use server';

import { revalidatePath } from 'next/cache';
import { prisma } from '@/lib/prisma';

export async function createNote(formData: FormData) {
  const title = formData.get('title') as string;
  const content = formData.get('content') as string;

  await prisma.fleetingNote.create({
    data: { title, content, userId: session.user.id }
  });

  revalidatePath('/notes');
}

// components/notes/NoteForm.tsx
'use client';

import { createNote } from '@/app/notes/actions';

export function NoteForm() {
  return (
    <form action={createNote}>
      <input name="title" />
      <textarea name="content" />
      <button type="submit">ä½œæˆ</button>
    </form>
  );
}
```

### ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã¨ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ

#### ãƒ«ãƒ¼ãƒˆã‚°ãƒ«ãƒ¼ãƒ—ã®æ´»ç”¨
èªè¨¼çŠ¶æ…‹ã‚„ç•°ãªã‚‹ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã§`()`ã‚’ä½¿ç”¨ï¼š
```
app/
â”œâ”€â”€ (auth)/
â”‚   â”œâ”€â”€ login/page.tsx
â”‚   â””â”€â”€ register/page.tsx
â””â”€â”€ (dashboard)/
    â”œâ”€â”€ layout.tsx         # èªè¨¼å¾Œã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ
    â””â”€â”€ page.tsx
```

#### ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã§ã®å…±é€šå‡¦ç†
- èªè¨¼ãƒã‚§ãƒƒã‚¯ã¯ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã§å®Ÿæ–½
- å…±é€šã®ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‚„ãƒ˜ãƒƒãƒ€ãƒ¼ã¯ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã«é…ç½®
- `loading.tsx`ã§ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã‚’ç®¡ç†
- `error.tsx`ã§ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

```typescript
// app/(dashboard)/layout.tsx
export default async function DashboardLayout({ children }) {
  const session = await auth();
  if (!session) redirect('/login');

  return (
    <div className="flex">
      <Sidebar />
      <main>{children}</main>
    </div>
  );
}
```

### ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã¨SEO

#### é™çš„ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿
```typescript
// app/(dashboard)/notes/page.tsx
export const metadata = {
  title: 'ãƒ¡ãƒ¢ä¸€è¦§',
  description: 'ã‚ãªãŸã®å…¨ã¦ã®ãƒ¡ãƒ¢ã‚’ç®¡ç†',
};
```

#### å‹•çš„ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿
```typescript
// app/notes/[id]/page.tsx
export async function generateMetadata({ params }) {
  const note = await prisma.permanentNote.findUnique({
    where: { id: params.id }
  });

  return {
    title: note.title,
    description: note.content.slice(0, 100),
  };
}
```

### ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–

#### ç”»åƒã®æœ€é©åŒ–
```tsx
import Image from 'next/image';

// âœ… æ¨å¥¨
<Image
  src="/images/logo.png"
  alt="ãƒ­ã‚´"
  width={200}
  height={50}
  priority={true} // LCPã«é‡è¦ãªç”»åƒã«ä½¿ç”¨
/>
```

#### å‹•çš„ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
é‡ã„ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¯é…å»¶ãƒ­ãƒ¼ãƒ‰ï¼š
```typescript
import dynamic from 'next/dynamic';

// ã‚°ãƒ©ãƒ•ãƒ“ãƒ¥ãƒ¼ã¯é‡ã„ã®ã§ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ã§é…å»¶ãƒ­ãƒ¼ãƒ‰
const GraphView = dynamic(() => import('@/components/graph/GraphView'), {
  loading: () => <p>ã‚°ãƒ©ãƒ•ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>,
  ssr: false // SSRã‚’ã‚¹ã‚­ãƒƒãƒ—
});
```

#### ã‚­ãƒ£ãƒƒã‚·ãƒ³ã‚°ã¨ãƒªãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
```typescript
// 60ç§’ã”ã¨ã«å†æ¤œè¨¼
export const revalidate = 60;

// ã¾ãŸã¯å€‹åˆ¥ã«fetchã§æŒ‡å®š
const data = await fetch('https://api.example.com', {
  next: { revalidate: 3600 } // 1æ™‚é–“
});

// Server Actionsã§ã®å†æ¤œè¨¼
import { revalidatePath, revalidateTag } from 'next/cache';

revalidatePath('/notes'); // ç‰¹å®šãƒ‘ã‚¹ã‚’å†æ¤œè¨¼
revalidateTag('notes'); // ã‚¿ã‚°ä»˜ãã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’å†æ¤œè¨¼
```

### ãƒ•ã‚¡ã‚¤ãƒ«è¦ç´„

#### ç‰¹æ®Šãƒ•ã‚¡ã‚¤ãƒ«
- `page.tsx` - ãƒ«ãƒ¼ãƒˆã®UIã‚’å®šç¾©
- `layout.tsx` - å…±é€šãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ
- `loading.tsx` - ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°UIï¼ˆSuspenseã®è‡ªå‹•ãƒ©ãƒƒãƒ—ï¼‰
- `error.tsx` - ã‚¨ãƒ©ãƒ¼UIï¼ˆError Boundaryã®è‡ªå‹•ãƒ©ãƒƒãƒ—ï¼‰
- `not-found.tsx` - 404ãƒšãƒ¼ã‚¸
- `route.ts` - API Route Handler

#### ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒ•ã‚©ãƒ«ãƒ€
`_folder`ã§å§‹ã¾ã‚‹ãƒ•ã‚©ãƒ«ãƒ€ã¯ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‹ã‚‰é™¤å¤–ï¼š
```
app/
â”œâ”€â”€ _lib/          # ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°å¯¾è±¡å¤–
â”œâ”€â”€ _components/   # ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°å¯¾è±¡å¤–
â””â”€â”€ notes/
    â””â”€â”€ page.tsx   # /notes ã¨ã—ã¦ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½
```

### ç’°å¢ƒå¤‰æ•°

#### å‘½åè¦å‰‡
- **ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´**: `NEXT_PUBLIC_`ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ãŒå¿…é ˆ
- **ã‚µãƒ¼ãƒãƒ¼å´ã®ã¿**: ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ãªã—

```env
# ã‚µãƒ¼ãƒãƒ¼å´ã®ã¿
DATABASE_URL="postgresql://..."
NEXTAUTH_SECRET="..."

# ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãƒ»ã‚µãƒ¼ãƒãƒ¼ä¸¡æ–¹
NEXT_PUBLIC_SUPABASE_URL="..."
```

#### ä½¿ç”¨æ–¹æ³•
```typescript
// Server Component ã¾ãŸã¯ API Route
const dbUrl = process.env.DATABASE_URL; // OK

// Client Component
const apiUrl = process.env.NEXT_PUBLIC_API_URL; // OK
const dbUrl = process.env.DATABASE_URL; // undefinedï¼ˆã‚¢ã‚¯ã‚»ã‚¹ä¸å¯ï¼‰
```

### å‹å®‰å…¨æ€§

#### Prismaå‹ã®æ´»ç”¨
```typescript
import { Prisma } from '@prisma/client';

// Prismaç”Ÿæˆå‹ã‚’ä½¿ç”¨
type NoteWithCategories = Prisma.PermanentNoteGetPayload<{
  include: { categories: true }
}>;

// ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®propsã«ä½¿ç”¨
interface NoteCardProps {
  note: NoteWithCategories;
}
```

#### Zodã§ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
```typescript
// utils/validators.ts
import { z } from 'zod';

export const createNoteSchema = z.object({
  title: z.string().min(1, 'ã‚¿ã‚¤ãƒˆãƒ«ã¯å¿…é ˆã§ã™').max(200),
  content: z.string().optional(),
  categoryIds: z.array(z.string()).optional(),
});

export type CreateNoteInput = z.infer<typeof createNoteSchema>;
```

### ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£

#### èªè¨¼ãƒã‚§ãƒƒã‚¯
```typescript
// Server Componentã¾ãŸã¯API Routeã§å¿…ãšèªè¨¼ç¢ºèª
import { auth } from '@/lib/auth';

export default async function ProtectedPage() {
  const session = await auth();
  if (!session) redirect('/login');

  // èªè¨¼æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ãªå‡¦ç†
}
```

#### CSRFãƒˆãƒ¼ã‚¯ãƒ³
Server Actionsã¯è‡ªå‹•çš„ã«CSRFä¿è­·ã•ã‚Œã‚‹ãŸã‚è¿½åŠ å®Ÿè£…ä¸è¦ã€‚

#### XSSå¯¾ç­–
ReactãŒè‡ªå‹•ã§ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã™ã‚‹ãŒã€`dangerouslySetInnerHTML`ã¯é¿ã‘ã‚‹ï¼š
```tsx
// âœ… æ¨å¥¨: react-markdownã‚’ä½¿ç”¨
<ReactMarkdown>{content}</ReactMarkdown>

// âŒ é¿ã‘ã‚‹
<div dangerouslySetInnerHTML={{ __html: content }} />
```

## Supabase ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶š

#### Prismaã¨ã®çµ±åˆ
Prismaã‚’ORMã¨ã—ã¦ä½¿ç”¨ã—ã€Supabaseã®PostgreSQLã«æ¥ç¶šï¼š

```typescript
// prisma/schema.prisma
datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL") // Connection Poolingã‚’å›é¿ã™ã‚‹å ´åˆ
}

generator client {
  provider = "prisma-client-js"
}
```

```env
# .env
DATABASE_URL="postgresql://postgres:[PASSWORD]@db.[PROJECT_REF].supabase.co:5432/postgres?pgbouncer=true"
DIRECT_URL="postgresql://postgres:[PASSWORD]@db.[PROJECT_REF].supabase.co:5432/postgres"
```

#### Prismaã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®ã‚·ãƒ³ã‚°ãƒ«ãƒˆãƒ³åŒ–
é–‹ç™ºæ™‚ã®è¤‡æ•°ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ç”Ÿæˆã‚’é˜²ãï¼š

```typescript
// lib/prisma.ts
import { PrismaClient } from '@prisma/client';

const globalForPrisma = globalThis as unknown as {
  prisma: PrismaClient | undefined;
};

export const prisma =
  globalForPrisma.prisma ??
  new PrismaClient({
    log: process.env.NODE_ENV === 'development' ? ['query', 'error', 'warn'] : ['error'],
  });

if (process.env.NODE_ENV !== 'production') globalForPrisma.prisma = prisma;
```

### Row Level Security (RLS)

#### RLSãƒãƒªã‚·ãƒ¼ã®è¨­å®š
Supabaseã§ã¯å¿…ãšRLSã‚’æœ‰åŠ¹åŒ–ã—ã¦ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚’ç¢ºä¿ï¼š

```sql
-- fleeting_notesãƒ†ãƒ¼ãƒ–ãƒ«ã®ä¾‹
ALTER TABLE fleeting_notes ENABLE ROW LEVEL SECURITY;

-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯è‡ªåˆ†ã®ãƒ¡ãƒ¢ã®ã¿å‚ç…§å¯èƒ½
CREATE POLICY "Users can view their own fleeting notes"
  ON fleeting_notes
  FOR SELECT
  USING (auth.uid() = user_id);

-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯è‡ªåˆ†ã®ãƒ¡ãƒ¢ã®ã¿ä½œæˆå¯èƒ½
CREATE POLICY "Users can create their own fleeting notes"
  ON fleeting_notes
  FOR INSERT
  WITH CHECK (auth.uid() = user_id);

-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯è‡ªåˆ†ã®ãƒ¡ãƒ¢ã®ã¿æ›´æ–°å¯èƒ½
CREATE POLICY "Users can update their own fleeting notes"
  ON fleeting_notes
  FOR UPDATE
  USING (auth.uid() = user_id)
  WITH CHECK (auth.uid() = user_id);

-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯è‡ªåˆ†ã®ãƒ¡ãƒ¢ã®ã¿å‰Šé™¤å¯èƒ½
CREATE POLICY "Users can delete their own fleeting notes"
  ON fleeting_notes
  FOR DELETE
  USING (auth.uid() = user_id);
```

#### Service Roleã®ä½¿ç”¨
RLSã‚’ãƒã‚¤ãƒ‘ã‚¹ã™ã‚‹å¿…è¦ãŒã‚ã‚‹å ´åˆï¼ˆç®¡ç†æ©Ÿèƒ½ãªã©ï¼‰ï¼š

```typescript
// lib/supabase-admin.ts
import { createClient } from '@supabase/supabase-js';

// Service Role Keyã¯çµ¶å¯¾ã«ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã«å…¬é–‹ã—ãªã„
export const supabaseAdmin = createClient(
  process.env.NEXT_PUBLIC_SUPABASE_URL!,
  process.env.SUPABASE_SERVICE_ROLE_KEY!, // ã‚µãƒ¼ãƒãƒ¼å´ã®ã¿
  {
    auth: {
      autoRefreshToken: false,
      persistSession: false
    }
  }
);
```

### ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç®¡ç†

#### Prisma Migrateã®ä½¿ç”¨
```bash
# ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ä½œæˆ
npx prisma migrate dev --name add_categories

# æœ¬ç•ªç’°å¢ƒã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤
npx prisma migrate deploy
```

#### Supabase CLIã¨ã®ä½µç”¨
Supabaseç‰¹æœ‰ã®æ©Ÿèƒ½ï¼ˆStorageã€Edge Functionsãªã©ï¼‰ï¼š

```bash
# Supabaseãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¨é€£æº
npx supabase init
npx supabase link --project-ref [PROJECT_REF]

# ãƒ­ãƒ¼ã‚«ãƒ«ã§Supabaseã‚’èµ·å‹•
npx supabase start

# ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®ä½œæˆ
npx supabase migration new add_rls_policies
```

### ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ©Ÿèƒ½

ã“ã®ã‚¢ãƒ—ãƒªã§ã¯å½“é¢ä¸è¦ã ãŒã€å°†æ¥çš„ãªæ‹¡å¼µã®å ´åˆï¼š

```typescript
// ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è³¼èª­ï¼ˆãƒãƒ¼ãƒ æ©Ÿèƒ½ã§ä½¿ç”¨å¯èƒ½ï¼‰
'use client';

import { useEffect } from 'react';
import { createClient } from '@supabase/supabase-js';

export function useRealtimeNotes() {
  useEffect(() => {
    const supabase = createClient(
      process.env.NEXT_PUBLIC_SUPABASE_URL!,
      process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
    );

    const channel = supabase
      .channel('notes-changes')
      .on(
        'postgres_changes',
        {
          event: '*',
          schema: 'public',
          table: 'permanent_notes'
        },
        (payload) => {
          console.log('Change received!', payload);
          // çŠ¶æ…‹ã‚’æ›´æ–°
        }
      )
      .subscribe();

    return () => {
      supabase.removeChannel(channel);
    };
  }, []);
}
```

### ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã¨ãƒªã‚¹ãƒˆã‚¢

```bash
# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼ˆSupabase Dashboardæ¨å¥¨ï¼‰
# ã¾ãŸã¯ pg_dump ã‚’ä½¿ç”¨
pg_dump "postgresql://postgres:[PASSWORD]@db.[PROJECT_REF].supabase.co:5432/postgres" > backup.sql

# ãƒªã‚¹ãƒˆã‚¢
psql "postgresql://postgres:[PASSWORD]@db.[PROJECT_REF].supabase.co:5432/postgres" < backup.sql
```

## Auth.js (NextAuth.js v5) ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

### åŸºæœ¬ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

#### Auth.jsè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«
```typescript
// lib/auth.ts
import NextAuth from "next-auth";
import Google from "next-auth/providers/google";
import Credentials from "next-auth/providers/credentials";
import { PrismaAdapter } from "@auth/prisma-adapter";
import { prisma } from "./prisma";
import bcrypt from "bcryptjs";

export const { handlers, auth, signIn, signOut } = NextAuth({
  adapter: PrismaAdapter(prisma),
  session: {
    strategy: "jwt", // JWTã‚’ä½¿ç”¨ï¼ˆSupabaseã¨ã®ç›¸æ€§ãŒè‰¯ã„ï¼‰
  },
  pages: {
    signIn: "/login",
    error: "/login",
  },
  providers: [
    Google({
      clientId: process.env.GOOGLE_CLIENT_ID!,
      clientSecret: process.env.GOOGLE_CLIENT_SECRET!,
      allowDangerousEmailAccountLinking: true, // ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã§ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆçµ±åˆ
    }),
    Credentials({
      credentials: {
        email: { label: "Email", type: "email" },
        password: { label: "Password", type: "password" },
      },
      async authorize(credentials) {
        if (!credentials?.email || !credentials?.password) {
          return null;
        }

        const user = await prisma.user.findUnique({
          where: { email: credentials.email as string },
        });

        if (!user || !user.hashedPassword) {
          return null;
        }

        const isValid = await bcrypt.compare(
          credentials.password as string,
          user.hashedPassword
        );

        if (!isValid) {
          return null;
        }

        return {
          id: user.id,
          email: user.email,
          name: user.name,
        };
      },
    }),
  ],
  callbacks: {
    async jwt({ token, user }) {
      // JWTãƒˆãƒ¼ã‚¯ãƒ³ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’è¿½åŠ 
      if (user) {
        token.userId = user.id;
      }
      return token;
    },
    async session({ session, token }) {
      // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’è¿½åŠ 
      if (session.user) {
        session.user.id = token.userId as string;
      }
      return session;
    },
  },
});
```

#### API Route Handler
```typescript
// app/api/auth/[...nextauth]/route.ts
import { handlers } from "@/lib/auth";

export const { GET, POST } = handlers;
```

#### å‹å®šç¾©ã®æ‹¡å¼µ
```typescript
// types/next-auth.d.ts
import NextAuth from "next-auth";

declare module "next-auth" {
  interface Session {
    user: {
      id: string;
      email: string;
      name?: string;
      image?: string;
    };
  }
}
```

### èªè¨¼ã®å®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³

#### Server Componentsã§ã®èªè¨¼ãƒã‚§ãƒƒã‚¯
```typescript
// app/(dashboard)/page.tsx
import { auth } from "@/lib/auth";
import { redirect } from "next/navigation";

export default async function DashboardPage() {
  const session = await auth();

  if (!session) {
    redirect("/login");
  }

  // èªè¨¼æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½
  return <div>ã‚ˆã†ã“ãã€{session.user.name}ã•ã‚“</div>;
}
```

#### Middlewareã§ã®èªè¨¼ä¿è­·
```typescript
// middleware.ts
import { auth } from "@/lib/auth";
import { NextResponse } from "next/server";

export default auth((req) => {
  const isLoggedIn = !!req.auth;
  const isAuthPage = req.nextUrl.pathname.startsWith("/login") ||
                     req.nextUrl.pathname.startsWith("/register");

  if (isAuthPage) {
    if (isLoggedIn) {
      // ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯èªè¨¼ãƒšãƒ¼ã‚¸ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ããªã„
      return NextResponse.redirect(new URL("/", req.url));
    }
    return NextResponse.next();
  }

  if (!isLoggedIn) {
    // æœªèªè¨¼ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ä¿è­·ã•ã‚ŒãŸãƒšãƒ¼ã‚¸ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ããªã„
    return NextResponse.redirect(new URL("/login", req.url));
  }

  return NextResponse.next();
});

export const config = {
  matcher: ["/((?!api|_next/static|_next/image|favicon.ico).*)"],
};
```

#### Client Componentsã§ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³å–å¾—
```typescript
// app/providers.tsx
'use client';

import { SessionProvider } from "next-auth/react";

export function Providers({ children }: { children: React.ReactNode }) {
  return <SessionProvider>{children}</SessionProvider>;
}

// app/layout.tsx
import { Providers } from "./providers";

export default function RootLayout({ children }) {
  return (
    <html>
      <body>
        <Providers>{children}</Providers>
      </body>
    </html>
  );
}

// components/Header.tsx
'use client';

import { useSession, signOut } from "next-auth/react";

export function Header() {
  const { data: session } = useSession();

  if (!session) return null;

  return (
    <header>
      <p>{session.user.email}</p>
      <button onClick={() => signOut()}>ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
    </header>
  );
}
```

### ãƒ­ã‚°ã‚¤ãƒ³ãƒ»ç™»éŒ²ã®å®Ÿè£…

#### ãƒ­ã‚°ã‚¤ãƒ³ãƒ•ã‚©ãƒ¼ãƒ ï¼ˆServer Actionsä½¿ç”¨ï¼‰
```typescript
// app/(auth)/login/page.tsx
import { signIn } from "@/lib/auth";
import { redirect } from "next/navigation";

export default function LoginPage() {
  async function handleCredentialsLogin(formData: FormData) {
    "use server";

    const email = formData.get("email") as string;
    const password = formData.get("password") as string;

    const result = await signIn("credentials", {
      email,
      password,
      redirect: false,
    });

    if (result?.error) {
      // ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
      return { error: "ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ" };
    }

    redirect("/");
  }

  async function handleGoogleLogin() {
    "use server";
    await signIn("google", { redirectTo: "/" });
  }

  return (
    <div>
      <h1>ãƒ­ã‚°ã‚¤ãƒ³</h1>

      {/* èªè¨¼æƒ…å ±ã§ãƒ­ã‚°ã‚¤ãƒ³ */}
      <form action={handleCredentialsLogin}>
        <input name="email" type="email" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹" required />
        <input name="password" type="password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" required />
        <button type="submit">ãƒ­ã‚°ã‚¤ãƒ³</button>
      </form>

      {/* Googleã§ãƒ­ã‚°ã‚¤ãƒ³ */}
      <form action={handleGoogleLogin}>
        <button type="submit">Googleã§ãƒ­ã‚°ã‚¤ãƒ³</button>
      </form>
    </div>
  );
}
```

#### ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²
```typescript
// app/(auth)/register/actions.ts
"use server";

import { prisma } from "@/lib/prisma";
import bcrypt from "bcryptjs";
import { signIn } from "@/lib/auth";
import { z } from "zod";

const registerSchema = z.object({
  name: z.string().min(1, "åå‰ã¯å¿…é ˆã§ã™"),
  email: z.string().email("æœ‰åŠ¹ãªãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"),
  password: z.string().min(8, "ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯8æ–‡å­—ä»¥ä¸Šã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™"),
});

export async function registerUser(formData: FormData) {
  const validatedFields = registerSchema.safeParse({
    name: formData.get("name"),
    email: formData.get("email"),
    password: formData.get("password"),
  });

  if (!validatedFields.success) {
    return { error: "å…¥åŠ›å†…å®¹ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“" };
  }

  const { name, email, password } = validatedFields.data;

  // æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒã‚§ãƒƒã‚¯
  const existingUser = await prisma.user.findUnique({
    where: { email },
  });

  if (existingUser) {
    return { error: "ã“ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯æ—¢ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™" };
  }

  // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®ãƒãƒƒã‚·ãƒ¥åŒ–
  const hashedPassword = await bcrypt.hash(password, 10);

  // ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆ
  await prisma.user.create({
    data: {
      name,
      email,
      hashedPassword,
    },
  });

  // è‡ªå‹•ãƒ­ã‚°ã‚¤ãƒ³
  await signIn("credentials", {
    email,
    password,
    redirect: false,
  });

  return { success: true };
}
```

### ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

#### ç’°å¢ƒå¤‰æ•°ã®è¨­å®š
```env
# .env
NEXTAUTH_URL="http://localhost:3000"
NEXTAUTH_SECRET="your-secret-key-here" # openssl rand -base64 32 ã§ç”Ÿæˆ

# Google OAuth
GOOGLE_CLIENT_ID="your-google-client-id"
GOOGLE_CLIENT_SECRET="your-google-client-secret"

# Database
DATABASE_URL="postgresql://..."
```

#### ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®ãƒãƒƒã‚·ãƒ¥åŒ–
```typescript
import bcrypt from "bcryptjs";

// ç™»éŒ²æ™‚
const hashedPassword = await bcrypt.hash(password, 10);

// ãƒ­ã‚°ã‚¤ãƒ³æ™‚ã®æ¤œè¨¼
const isValid = await bcrypt.compare(password, user.hashedPassword);
```

#### CSRFãƒˆãƒ¼ã‚¯ãƒ³ä¿è­·
Auth.js v5ã¯è‡ªå‹•çš„ã«CSRFä¿è­·ã‚’æä¾›ã€‚Server Actionsã‚‚è‡ªå‹•ä¿è­·ã€‚

#### ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†
```typescript
// JWTã‚¹ãƒˆãƒ©ãƒ†ã‚¸ãƒ¼ã‚’ä½¿ç”¨ï¼ˆæ¨å¥¨ï¼‰
session: {
  strategy: "jwt",
  maxAge: 30 * 24 * 60 * 60, // 30æ—¥
}

// ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ä½¿ç”¨ã™ã‚‹å ´åˆ
session: {
  strategy: "database",
  maxAge: 30 * 24 * 60 * 60,
  updateAge: 24 * 60 * 60, // 24æ™‚é–“ã”ã¨ã«æ›´æ–°
}
```

### Server Actionsã§ã®èªè¨¼åˆ©ç”¨

```typescript
// app/notes/actions.ts
"use server";

import { auth } from "@/lib/auth";
import { prisma } from "@/lib/prisma";
import { revalidatePath } from "next/cache";

export async function createNote(formData: FormData) {
  // èªè¨¼ãƒã‚§ãƒƒã‚¯
  const session = await auth();
  if (!session?.user?.id) {
    throw new Error("èªè¨¼ãŒå¿…è¦ã§ã™");
  }

  const title = formData.get("title") as string;
  const content = formData.get("content") as string;

  // ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’è‡ªå‹•çš„ã«è¨­å®š
  await prisma.fleetingNote.create({
    data: {
      title,
      content,
      userId: session.user.id, // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‹ã‚‰å–å¾—
    },
  });

  revalidatePath("/");
}
```

### API Routesã§ã®èªè¨¼

```typescript
// app/api/notes/route.ts
import { auth } from "@/lib/auth";
import { prisma } from "@/lib/prisma";
import { NextResponse } from "next/server";

export async function GET(request: Request) {
  const session = await auth();

  if (!session?.user?.id) {
    return NextResponse.json({ error: "Unauthorized" }, { status: 401 });
  }

  const notes = await prisma.permanentNote.findMany({
    where: { userId: session.user.id },
  });

  return NextResponse.json(notes);
}
```

## é‡è¦ãªè¨­è¨ˆä¸Šã®æ³¨æ„ç‚¹

### ãƒ¡ãƒ¢æ¸ˆã¿ãƒã‚§ãƒƒã‚¯ã®å®Ÿè£…

èµ°ã‚Šæ›¸ããƒ¡ãƒ¢ã¾ãŸã¯æ–‡çŒ®ãƒ¡ãƒ¢ã§`isDone`ãƒ•ãƒ©ã‚°ã‚’trueã«ã—ãŸéš›ï¼š
1. è‡ªå‹•çš„ã«æ–°ã—ã„æ°¸ä¹…ä¿å­˜ãƒ¡ãƒ¢ã‚’ä½œæˆ
2. `sourceType`ã¨`sourceId`ã«å…ƒãƒ¡ãƒ¢ã®æƒ…å ±ã‚’è¨˜éŒ²
3. å…ƒãƒ¡ãƒ¢ã¯ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿æŒï¼ˆå‰Šé™¤ã—ãªã„ï¼‰
4. ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã®ä¸€è¦§ã‹ã‚‰ã¯éè¡¨ç¤ºï¼ˆ`isDone = false`ã®ã¿è¡¨ç¤ºï¼‰

### Markdownã‚¨ãƒ‡ã‚£ã‚¿ã®å®Ÿè£…

```tsx
<ReactMarkdown
  remarkPlugins={[remarkGfm]}
  rehypePlugins={[rehypeHighlight]}
  skipHtml={false}
  unwrapDisallowed={true}
>
  {content}
</ReactMarkdown>
```

### ãƒªãƒ³ã‚¯è¨˜æ³•ã®è§£æ

- `[[ãƒ¡ãƒ¢ã‚¿ã‚¤ãƒˆãƒ«]]`ã‚’æ­£è¦è¡¨ç¾ã§æ¤œå‡º
- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã§ã‚¿ã‚¤ãƒˆãƒ«ã‚’æ¤œç´¢
- è©²å½“ãƒ¡ãƒ¢ã¸ã®ãƒªãƒ³ã‚¯ã«å¤‰æ›
- `permanent_note_links`ãƒ†ãƒ¼ãƒ–ãƒ«ã«è‡ªå‹•ç™»éŒ²ã—ã¦ãƒãƒƒã‚¯ãƒªãƒ³ã‚¯ã‚’è¿½è·¡

### ã‚°ãƒ©ãƒ•ãƒ‡ãƒ¼ã‚¿æ§‹é€ 

```typescript
{
  nodes: Array<{
    id: string
    name: string
    connections: number
    group: number  // ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚„ãƒ¡ãƒ¢ã‚¿ã‚¤ãƒ—ã§è‰²åˆ†ã‘
  }>
  links: Array<{
    source: string
    target: string
  }>
}
```
